# Do a shared library build with local dependencies (MSVC Only).
name: Build MSVC DLL for Qt
on:
  # 允许手动触发，实现云端一键构建
  workflow_dispatch:
  # 可选：推送到主分支时也触发（您可按需删除）
  push:
    branches: [ main, master ]

# 必须有写入权限才能创建Release
permissions:
  contents: write

jobs:
  build-msvc-dll:
    runs-on: windows-latest
    # 关键：只使用MSVC编译器，移除clang-cl矩阵
    strategy:
      matrix:
        compiler: [msvc]  # 只保留msvc

    steps:
      # 1. 检出代码
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # 2. 使用原项目的环境设置
      - uses: ./.github/actions/setup-windows
        with:
          codec-aom: "LOCAL"
          codec-dav1d: "LOCAL"
          extra-cache-key: ${{ matrix.compiler }}

      # 3. 配置CMake (MSVC，动态库)
      - name: Configure CMake for MSVC DLL
        run: >
          cmake -G Ninja -S . -B build
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_SHARED_LIBS=ON
          -DAVIF_CODEC_AOM=LOCAL
          -DAVIF_CODEC_DAV1D=LOCAL
          -DAVIF_JPEG=LOCAL
          -DAVIF_LIBSHARPYUV=LOCAL
          -DAVIF_LIBYUV=LOCAL
          -DAVIF_ZLIBPNG=LOCAL
          -DAVIF_BUILD_APPS=ON
          -DAVIF_BUILD_TESTS=ON
          -DAVIF_GTEST=LOCAL

      # 4. 编译
      - name: Build
        run: cmake --build build --config Release --parallel 4

      # 5. 运行测试（确保库的正确性）
      - name: Run Tests
        working-directory: ./build
        run: ctest -j $Env:NUMBER_OF_PROCESSORS --output-on-failure

      # ========== 以下是打包和发布步骤 ==========
      # 6. 打包完整的构建目录（修正版）
      - name: Package Complete Build Output
        if: success()
        shell: cmd
        run: |
          echo "正在打包构建产物..."
          mkdir qt_msvc_package
          # 复制完整的构建输出目录（包含所有.dll, .lib, .exe等）
          xcopy /E /I build\Release qt_msvc_package\bin\
          # 复制完整的头文件目录树
          xcopy /E /I include qt_msvc_package\include\
          # 创建压缩包
          7z a libavif-msvc-qt-package.zip .\qt_msvc_package\*
          echo "=== 压缩包内容列表（供验证）==="
          7z l libavif-msvc-qt-package.zip

      # 7. 创建/覆盖 Release
      - name: Create/Update Release for Qt
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          # 固定标签和名称，每次覆盖更新
          tag_name: v1
          name: "libavif MSVC DLL for Qt"
          body: |
            专为 Qt (MSVC) 构建的 libavif 动态库完整包。
            包含：
            - `bin/` 目录：avif.dll, avif.lib, 命令行工具
            - `include/` 目录：所有必需的头文件
            构建时间：${{ github.event.head_commit.timestamp }}
            注意：此版本会被后续构建覆盖更新。
          files: libavif-msvc-qt-package.zip
          replace: true  # 覆盖旧的Release
          draft: false
          prerelease: false
