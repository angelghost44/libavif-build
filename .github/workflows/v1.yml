# 专为 Qt (MSVC) 构建 libavif 动态库并发布
name: Build and Release MSVC DLL for Qt

on:
  # 手动触发，实现云端一键构建
  workflow_dispatch:
  # 可选：推送到主分支时也触发（可按需删除）
  push:
    branches: [ main, master ]

# 必须有写入权限才能创建 Release
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    # 只使用 MSVC 编译器，移除 clang-cl
    strategy:
      matrix:
        compiler: [msvc]

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 使用原项目的环境设置
      - name: Setup Windows Build Environment
        uses: ./.github/actions/setup-windows
        with:
          codec-aom: "LOCAL"
          codec-dav1d: "LOCAL"
          extra-cache-key: ${{ matrix.compiler }}

      # 3. 配置 CMake (MSVC，动态库)
      - name: Configure CMake for MSVC DLL
        run: >
          cmake -G Ninja -S . -B build
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_SHARED_LIBS=ON
          -DAVIF_CODEC_AOM=LOCAL
          -DAVIF_CODEC_DAV1D=LOCAL
          -DAVIF_JPEG=LOCAL
          -DAVIF_LIBSHARPYUV=LOCAL
          -DAVIF_LIBYUV=LOCAL
          -DAVIF_ZLIBPNG=LOCAL
          -DAVIF_BUILD_APPS=ON
          -DAVIF_BUILD_TESTS=ON
          -DAVIF_GTEST=LOCAL

      # 4. 编译
      - name: Build
        run: cmake --build build --config Release --parallel 4

      # 5. 运行测试（确保库的正确性）
      - name: Run Tests
        working-directory: ./build
        run: ctest -j $Env:NUMBER_OF_PROCESSORS --output-on-failure

      # ========== 打包和发布步骤 ==========
      # 6. 打包完整的构建目录（关键修正：使用双反斜杠避免转义）
      - name: Package Complete Build Output
        if: success()
        shell: cmd
        run: |
          echo 正在打包构建产物...
          mkdir qt_msvc_package
          
          # 核心：直接复制整个 build 目录（无论什么结构都包含）
          xcopy /E /I build qt_msvc_package\\build\\
          
          # 复制头文件
          xcopy /E /I include qt_msvc_package\\include\\
          
          # 创建压缩包
          7z a libavif-msvc-qt-package.zip .\\qt_msvc_package\\*
          
          echo === 压缩包内容验证 ===
          7z l libavif-msvc-qt-package.zip
          echo 打包完成。

      # 7. 创建/覆盖 Release
      - name: Create/Update Release for Qt
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          # 固定标签和名称，每次覆盖更新
          tag_name: v1
          name: "libavif MSVC DLL for Qt"
          body: |
            专为 Qt (MSVC) 构建的 libavif 动态库完整包。
            包含：
            - `bin/` 目录：avif.dll, avif.lib, 命令行工具
            - `include/` 目录：所有必需的头文件
            构建时间：${{ github.event.head_commit.timestamp }}
            注意：此版本会被后续构建覆盖更新。
          files: libavif-msvc-qt-package.zip
          replace: true  # 覆盖旧的 Release
          draft: false
          prerelease: false
